name: Deploy to AWS with Vector Search & AI ChatBot

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  AWS_REGION: eu-central-1
  ECR_REGISTRY: 851725596604.dkr.ecr.eu-central-1.amazonaws.com
  # Cost-optimized Vector DB Configuration
  USE_COST_OPTIMIZED: true
  USE_AWS_NATIVE_VECTOR_DB: false

jobs:
  # Setup AWS Bedrock and prepare infrastructure
  setup-aws-infrastructure:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Check Bedrock model access
      run: |
        echo "ğŸ§  Checking AWS Bedrock model access..."
        
        # Check if Claude Haiku is available (cost-optimized)
        if aws bedrock list-foundation-models --region $AWS_REGION --query 'modelSummaries[?modelId==`anthropic.claude-3-haiku-20240307-v1:0`]' --output text | grep -q claude; then
          echo "âœ… Claude 3 Haiku model access confirmed"
        else
          echo "âš ï¸  Claude 3 Haiku model access needs to be enabled in AWS Console"
          echo "ğŸ‘‰ Go to AWS Console â†’ Bedrock â†’ Model Access â†’ Enable Claude 3 Haiku"
        fi
        
        # Check if Titan Embeddings is available (optional for cost-optimized)
        if aws bedrock list-foundation-models --region $AWS_REGION --query 'modelSummaries[?modelId==`amazon.titan-embed-text-v1`]' --output text | grep -q titan; then
          echo "âœ… Titan Embeddings model access confirmed"
        else
          echo "âš ï¸  Titan Embeddings access needs to be enabled (optional for cost-optimized version)"
        fi

    - name: Update DynamoDB table for vector search
      run: |
        echo "ğŸ—„ï¸  Checking DynamoDB table for vector search capabilities..."
        
        # The table should already exist from previous deployments
        TABLE_NAME="proov_jobs"
        
        if aws dynamodb describe-table --table-name $TABLE_NAME --region $AWS_REGION > /dev/null 2>&1; then
          echo "âœ… DynamoDB table '$TABLE_NAME' exists"
          echo "ğŸ” Cost-optimized vector search will use existing table structure"
        else
          echo "âŒ DynamoDB table '$TABLE_NAME' not found"
          exit 1
        fi

  deploy-backend:
    runs-on: ubuntu-latest
    needs: setup-aws-infrastructure
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build and push backend image with AI features
      working-directory: ./backend
      run: |
        echo "ğŸš€ Building backend with cost-optimized AI features..."
        docker build -t backend .
        docker tag backend:latest $ECR_REGISTRY/backend:latest
        docker push $ECR_REGISTRY/backend:latest

    - name: Get current ECS task definition
      run: |
        echo "ğŸ“‹ Getting current task definition..."
        aws ecs describe-task-definition \
          --task-definition backend-task \
          --region $AWS_REGION \
          --query 'taskDefinition' > current-task-def.json

    - name: Update task definition with AI environment variables
      run: |
        echo "ğŸ”§ Adding AI environment variables to task definition..."
        
        # Create updated task definition with new environment variables
        jq --arg region "$AWS_REGION" \
           --arg use_cost_optimized "$USE_COST_OPTIMIZED" \
           --arg use_aws_native "$USE_AWS_NATIVE_VECTOR_DB" \
           '.containerDefinitions[0].environment += [
             {"name": "USE_COST_OPTIMIZED", "value": $use_cost_optimized},
             {"name": "USE_AWS_NATIVE_VECTOR_DB", "value": $use_aws_native},
             {"name": "AWS_DEFAULT_REGION", "value": $region}
           ] | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .placementConstraints, .compatibilities, .registeredAt, .registeredBy)' \
           current-task-def.json > updated-task-def.json
        
        echo "ğŸ“ Updated task definition:"
        cat updated-task-def.json

    - name: Register new task definition
      run: |
        echo "ğŸ“ Registering new task definition..."
        NEW_TASK_DEF=$(aws ecs register-task-definition \
          --cli-input-json file://updated-task-def.json \
          --region $AWS_REGION \
          --query 'taskDefinition.taskDefinitionArn' \
          --output text)
        
        echo "âœ… New task definition: $NEW_TASK_DEF"
        echo "NEW_TASK_DEF=$NEW_TASK_DEF" >> $GITHUB_ENV

    - name: Update backend service with AI features
      run: |
        echo "ğŸ”„ Updating ECS service with AI-enabled backend..."
        aws ecs update-service \
          --cluster my-cluster \
          --service backend-service \
          --task-definition $NEW_TASK_DEF \
          --force-new-deployment \
          --region $AWS_REGION

    - name: Wait for deployment to complete
      run: |
        echo "â³ Waiting for deployment to complete..."
        aws ecs wait services-stable \
          --cluster my-cluster \
          --services backend-service \
          --region $AWS_REGION

    - name: Verify AI features
      run: |
        echo "ğŸ§ª Testing AI features after deployment..."
        
        # Wait a bit for the service to be fully ready
        sleep 30
        
        # Get the service endpoint (you may need to adjust this based on your ALB setup)
        echo "ğŸ” AI Vector Search & ChatBot should now be available!"
        echo "ğŸ“Š Features enabled:"
        echo "  âœ… Cost-optimized Vector Search (DynamoDB-based)"
        echo "  âœ… AWS Bedrock ChatBot (Claude 3 Haiku)"
        echo "  âœ… Label Detection (AWS Rekognition)"
        echo "  âœ… Semantic Video Search"
        echo ""
        echo "ğŸ’° Estimated monthly costs: $2-5 (90% savings!)"

    - name: Cleanup temporary files
      run: |
        echo "ğŸ§¹ Cleaning up temporary files..."
        rm -f current-task-def.json updated-task-def.json

    - name: Deployment Summary
      run: |
        echo "ğŸ‰ DEPLOYMENT SUCCESSFUL! ğŸ‰"
        echo ""
        echo "ğŸš€ Your AI-enhanced video analysis system is now live!"
        echo ""
        echo "ğŸ“‹ Features Deployed:"
        echo "  ğŸ¬ AWS Rekognition Label Detection"
        echo "  ğŸ” Cost-Optimized Vector Search (DynamoDB)"
        echo "  ğŸ¤– AI ChatBot (AWS Bedrock + Claude 3 Haiku)"
        echo "  ğŸ’¬ Semantic Video Search ('woman in red dress')"
        echo ""
        echo "ğŸ’¡ Usage:"
        echo "  1. Upload videos â†’ automatic label detection"
        echo "  2. Use ChatBot for semantic search"
        echo "  3. Ask questions like 'welches video hat eine frau mit roten kleid'"
        echo ""
        echo "ğŸ’° Cost Optimization: ~$2-5/month (90% savings vs premium solution)"
        echo ""
        echo "ğŸ”§ Next Steps:"
        echo "  - Test the new ChatBot feature in your frontend"
        echo "  - Upload some videos to see label detection in action"
        echo "  - Try semantic searches!"

  deploy-worker:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build and push worker image
      working-directory: ./backend
      run: |
        docker build -f worker/Dockerfile -t worker .
        docker tag worker:latest $ECR_REGISTRY/worker:latest
        docker push $ECR_REGISTRY/worker:latest

    - name: Update worker service
      run: |
        aws ecs update-service \
          --cluster my-cluster \
          --service worker-service \
          --force-new-deployment \
          --region $AWS_REGION

  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: './frontend/package-lock.json'

    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Build frontend
      working-directory: ./frontend
      run: npm run build

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy to S3
      working-directory: ./frontend
      run: |
        aws s3 sync dist/ s3://your-frontend-bucket-name --delete

    - name: Invalidate CloudFront
      run: |
        aws cloudfront create-invalidation \
          --distribution-id YOUR_CLOUDFRONT_DISTRIBUTION_ID \
          --paths "/*"